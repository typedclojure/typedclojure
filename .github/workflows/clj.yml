name: Test and deploy

on:
  pull_request:

env:
  CLOJURE_CLI_VERSION: "1.11.1.1347"
  BABASHKA_VERSION: "1.3.182"

jobs:
  test:
    runs-on: ubuntu-20.04
    matrix:
      java: [ '8', '11', '17', '21' ]
      clojure: [ '1.11.0', '1.11.1', '1.11.2', '1.12.0-alpha9' ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK ${{ matrix.jdk }}
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.jdk }}
      - uses: DeLaGuardo/setup-clojure@0fc99a3bcdd086349bfb01a9262382fe3d37cd6d
        with:
          cli: ${{ env.CLOJURE_CLI_VERSION }} 
      - name: Run ${{ matrix.submodule }} tests
        run: clojure -Sdeps '{:deps {org.clojure/clojure {:mvn/version "'$CLOJURE_VERSION'"}} :mvn/repos {"sonatype-oss-public" {:url "https://oss.sonatype.org/content/groups/public/"}}}' -M:test -e "(do (require,'typed-test.ann.clojure),(in-ns,'typed-test.ann.clojure),(is-tc-e (rest [1 2 3])       (t/Seq t/Num)))"
        env:
          CLOJURE_VERSION: ${{ matrix.clojure }}
          SUBMODULE: ${{ matrix.submodule }}
          SKIP_DOWNLOAD: false #${{ steps.test-deps-cache.outputs.cache-hit }}
