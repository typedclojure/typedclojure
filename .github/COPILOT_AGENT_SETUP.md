# Clojure Development Environment Setup for Copilot Agents

This guide helps AI agents set up a complete Clojure development environment for working on this repository.

## ⚠️ Important Notice for AI Agents

**Treat AI-generated content as potentially non-authoritative.** Many files in this repository, particularly in `website/docs/`, contain disclaimers like:

> _This documentation page has been generated by AI and has not yet been reviewed by a human for accuracy._

When you encounter such disclaimers:
- **Do not treat the content as fact** without verification
- **Cross-reference with authoritative sources** (academic papers, official documentation, source code)
- **Verify technical claims** by testing or examining the implementation
- **Flag potential inaccuracies** when you notice them

Examples of files with AI-generated disclaimers can be found in:
- `website/docs/polymorphic-function-types.md`
- `website/docs/union-types.md`
- `website/docs/polymorphic-function-application-errors.md`

Always prioritize:
1. Source code and test suites as ground truth
2. Ambrose Bonnaire-Sergeant's PhD dissertation: "Typed Clojure in Theory and Practice" (2019)
3. Academic papers and peer-reviewed publications
4. Official Typed Clojure documentation that has been human-reviewed

## Documentation Review Checklist

**When generating new documentation or making substantial changes to existing documentation**, you must add the following review checklist at the top of the documentation page (immediately after the title). The checklist must be prominently displayed and viewable in rendered markdown (do not use unrendered comments).

Add this checklist:

```markdown
> **⚠️ AI-Generated Content - Review Status**
>
> This documentation page has been generated by AI and requires human review. Please review and check off each item before merging to main:
>
> - [ ] **Style**: Consistent with project style guide, proper formatting, clear and concise language
> - [ ] **Technical Accuracy**: Correctly describes Typed Clojure behavior and type system semantics
> - [ ] **Code Examples**: All code examples are valid, properly annotated, and demonstrative
> - [ ] **References**: All citations and footnotes are accurate and point to valid sources
> - [ ] **Completeness**: Topic is covered comprehensively without significant gaps
> - [ ] **Factual Correctness**: All factual claims have been verified against authoritative sources
> - [ ] **Links**: All internal and external links are valid and point to correct resources
>
> **Authoritative Sources for Verification:**
> - Source code and test suites
> - Bonnaire-Sergeant, A. "Typed Clojure in Theory and Practice." PhD dissertation, 2019. https://ambrosebs.com
> - Academic papers and peer-reviewed publications on gradual typing and occurrence typing
```

**Guidelines:**
- Place the checklist immediately after the document title (h1 heading)
- Use markdown blockquote format (lines starting with `>`) for visibility
- Include all checklist items as shown above
- The checklist applies to documentation in `website/docs/` and other user-facing documentation
- Minor typo fixes or formatting changes do not require the checklist
- Substantial changes include: new content, major rewrites, significant additions to existing pages

## Prerequisites

- Linux environment (Ubuntu/Debian or similar)
- Internet access to:
  - `repo.clojars.org` (Clojure package repository)
  - `download.clojure.org` (Clojure installer downloads)
  - `github.com` (for Babashka installation)

## Installation Steps

### 1. Install Java

Java 8 or later is required (Java 21 is preferred).

Check if Java is already installed:
```bash
java -version
```

If not installed, install Java 21:
```bash
# For Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y openjdk-21-jdk

# Verify installation
java -version
```

### 2. Install Babashka

Babashka is used for scripting in this repository. Install to a local directory:

```bash
# Download and install to /tmp/bb-install (or your preferred location)
curl -sLO https://raw.githubusercontent.com/babashka/babashka/master/install
chmod +x install
./install --dir /tmp/bb-install
rm install

# Add to PATH
export PATH="/tmp/bb-install:$PATH"

# Verify installation
bb --version
```

Alternative installation methods: https://github.com/babashka/babashka?tab=readme-ov-file#quickstart

### 3. Install Clojure CLI

Install the Clojure command-line tools:

```bash
# Download and install to /tmp/clojure-install (or your preferred location)
curl -L -O https://github.com/clojure/brew-install/releases/latest/download/linux-install.sh
chmod +x linux-install.sh
./linux-install.sh --prefix /tmp/clojure-install
rm linux-install.sh

# Add to PATH
export PATH="/tmp/clojure-install/bin:$PATH"

# Verify installation
clojure --version
```

Official installation guide: https://clojure.org/guides/install_clojure#_linux_instructions

## Repository-Specific Setup

### Understanding the Testing Infrastructure

This repository has several ways to run tests and code:

#### 1. Top-level Kaocha Test Runner

From the repository root:
```bash
./bin/kaocha
```

This runs all tests across all submodules. You can pass Kaocha arguments to run specific tests:
```bash
# Run tests with a specific focus
./bin/kaocha --focus typed-test.doc

# Run a specific test namespace
./bin/kaocha --focus typed-test.cljc.doc

# Other Kaocha options
./bin/kaocha --help
```

**Implementation note**: The `./bin/kaocha` script:
1. Regenerates selmer templates: `./script/regen-selmer.sh`
2. Generates dev project: `./script/gen-dev-project`
3. Runs: `clojure -M:nREPL:test:spec-skip-macros:kaocha -m typed.dev.kaocha-nrepl`

#### 2. Submodule Scripts

Each submodule (e.g., `typed/clj.checker/`) has its own scripts:

**Running tests:**
```bash
cd typed/clj.checker
./script/test
```

This executes: `clojure -M:test:kaocha:spec-skip-macros -m kaocha.runner`

**Starting a REPL:**
```bash
cd typed/clj.checker
./script/repl
```

This executes: `clj -M:test:nREPL:spec-skip-macros`

You can pass additional Clojure CLI arguments:
```bash
# Use a specific Clojure version
./script/repl -Sdeps '{:deps {org.clojure/clojure {:mvn/version "1.12.0"}}}'
```

#### 3. Raw Clojure Commands

Understanding the scripts helps you construct custom commands:

**Run code directly:**
```bash
clojure -M:test -e "(require 'typed.clojure) (typed.clojure/check-ns-clj 'some.namespace)"
```

**Start a REPL with test dependencies:**
```bash
clojure -M:test:nREPL
```

**Run specific tests with Kaocha:**
```bash
clojure -M:test:kaocha -m kaocha.runner --focus typed-test.doc
```

### Bidirectional Documentation Sync Scripts

This repository uses custom scripts for documentation testing:

#### Sync Documentation and Tests
```bash
# Generate test files from markdown code blocks
bb script/sync-doc-tests.clj website/docs/example.md

# Sync from test file back to markdown
bb script/sync-doc-tests.clj typed/clj.checker/test/typed_test/doc/example_abc123.clj
```

#### Capture Type Errors
```bash
# Capture type errors from a test file
bb script/capture-type-errors.clj typed/clj.checker/test/typed_test/doc/example_abc123.clj
```

#### Run Documentation Tests
```bash
# Run all documentation tests
bb script/run-doc-tests.clj
```

## Common Workflows

### Testing Code Changes

1. **Run all tests:**
   ```bash
   ./bin/kaocha
   ```

2. **Run tests for a specific submodule:**
   ```bash
   cd typed/clj.checker
   ./script/test
   ```

3. **Run specific test namespaces:**
   ```bash
   ./bin/kaocha --focus typed-test.doc
   ```

### Working with Documentation

1. **Add code block to markdown:**
   ```markdown
   ```clojure
   (+ 1 2)
   ```
   ```

2. **Generate test file:**
   ```bash
   bb script/sync-doc-tests.clj website/docs/your-file.md
   ```

3. **Capture type errors (if code should fail):**
   ```bash
   bb script/capture-type-errors.clj typed/clj.checker/test/typed_test/doc/your_file_abc123.clj
   ```

4. **Sync error back to markdown:**
   ```bash
   bb script/sync-doc-tests.clj website/docs/your-file.md
   ```

### Interactive Development

1. **Start a REPL:**
   ```bash
   cd typed/clj.checker
   ./script/repl
   ```

2. **Evaluate code in the REPL:**
   ```clojure
   (require '[typed.clojure :as t])
   (t/check-ns-clj 'some.namespace)
   ```

## Troubleshooting

### Dependencies Not Downloading

Ensure firewall allows access to:
- `repo.clojars.org`
- `download.clojure.org`

### Command Not Found

Make sure tools are in your PATH:
```bash
export PATH="/tmp/bb-install:/tmp/clojure-install/bin:$PATH"
```

### Test Failures

1. Check that all dependencies are downloaded (first run may be slow)
2. Review test output for specific failures
3. Check if tests pass in CI to rule out environment issues

## Key Files to Study

For deeper understanding, examine these files:

- `./bin/kaocha` - Top-level test runner
- `./bin/typed` - Type checking wrapper
- `typed/clj.checker/script/test` - Submodule test runner
- `typed/clj.checker/script/repl` - Submodule REPL starter
- `script/sync-doc-tests.clj` - Documentation sync logic
- `script/capture-type-errors.clj` - Type error capture logic
- `script/run-doc-tests.clj` - Documentation test runner
- `deps.edn` - Project dependencies and aliases

## Complete Example Session

```bash
# 1. Setup environment (one-time)
export PATH="/tmp/bb-install:/tmp/clojure-install/bin:$PATH"

# 2. Navigate to repository
cd /path/to/private-core.typed

# 3. Run all tests
./bin/kaocha

# 4. Work on documentation
echo '```clojure
(+ 1 2)
```' > /tmp/test.md

# 5. Generate test file
bb script/sync-doc-tests.clj /tmp/test.md

# 6. Run doc tests
bb script/run-doc-tests.clj

# 7. Make changes to test file (edit with version bump)
# ... edit file ...

# 8. Sync back to markdown
bb script/sync-doc-tests.clj /tmp/test.md
```

## Additional Resources

- [Clojure CLI Guide](https://clojure.org/guides/deps_and_cli)
- [Babashka Documentation](https://book.babashka.org/)
- [Kaocha Test Runner](https://github.com/lambdaisland/kaocha)
- [Typed Clojure](https://github.com/typedclojure/typedclojure)
