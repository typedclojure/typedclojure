#!/bin/bash
# Download deps for cljr. Workaround https://github.com/clojure/clr.core.cli/issues/4
#
# Prerequisites:
# - cljr (ClojureCLR CLI tool) must be installed as a dotnet tool
# - .NET 8.0 or later must be installed
# - babashka must be installed for git serialization

set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/.." && pwd )"

# Clean up any stale lock file
rm -f /tmp/git-coordinator.lock

# Create a wrapper directory and git script
WRAPPER_DIR="$(mktemp -d)"
trap "rm -rf '$WRAPPER_DIR'" EXIT

# Make the git wrapper executable and add to PATH
ln -s "$SCRIPT_DIRtyped/clj.checker/script/git-wrapper.bb" "$WRAPPER_DIR/git"

# Run tests with git wrapper in PATH to serialize git operations
cd "$PROJECT_ROOT"
PATH="$WRAPPER_DIR:$PATH" cljr -A:test -Stree
