#!/bin/bash

# Script to perform binary search on clj-kondo releases to find the first release
# that breaks the clj-kondo-hooks tests.
#
# Usage: ./script/bisect-release [--quiet]
#
# With --quiet flag, outputs only: GOOD_RELEASE GOOD_COMMIT BAD_RELEASE BAD_COMMIT
# or "NONE" if no bad release found

set -e

QUIET_MODE=false
if [ "$1" = "--quiet" ]; then
    QUIET_MODE=true
fi

log() {
    if [ "$QUIET_MODE" = false ]; then
        echo "$@"
    fi
}

CLJ_KONDO_REPO="/tmp/clj-kondo-repo"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

log "=== clj-kondo Release Binary Search ==="
log ""

# Ensure clj-kondo repo is cloned
if [ ! -d "$CLJ_KONDO_REPO" ]; then
    log "Cloning clj-kondo repository..."
    git clone https://github.com/clj-kondo/clj-kondo.git "$CLJ_KONDO_REPO" >/dev/null 2>&1
fi

cd "$CLJ_KONDO_REPO"
git fetch origin --tags >/dev/null 2>&1

# Get all release tags from 2024-2025, sorted by version
log "Finding release tags..."
RELEASE_TAGS=$(git tag --sort=version:refname | grep "^v202[45]")
RELEASE_ARRAY=($RELEASE_TAGS)
TOTAL_RELEASES=${#RELEASE_ARRAY[@]}

log "Total releases found: $TOTAL_RELEASES"
log "Release range: ${RELEASE_ARRAY[0]} to ${RELEASE_ARRAY[$((TOTAL_RELEASES - 1))]}"
log ""

# Test a specific release
test_release() {
    local version=$1
    local version_num="${version#v}"  # Remove 'v' prefix
    
    log "Testing release: $version ($version_num)"
    
    # Install the release
    cd /tmp
    curl -sLO "https://github.com/clj-kondo/clj-kondo/releases/download/${version}/clj-kondo-${version_num}-linux-static-amd64.zip" 2>/dev/null
    
    if [ $? -ne 0 ]; then
        log "  Result: SKIP (release not available)"
        return 2
    fi
    
    mkdir -p /tmp/clj-kondo-install
    unzip -o "clj-kondo-${version_num}-linux-static-amd64.zip" -d /tmp/clj-kondo-install > /dev/null 2>&1
    rm "clj-kondo-${version_num}-linux-static-amd64.zip"
    
    # Verify version
    local installed_version=$(/tmp/clj-kondo-install/clj-kondo --version 2>/dev/null || echo "unknown")
    
    # Run the test
    cd "$PROJECT_DIR"
    export PATH="/tmp/clj-kondo-install:/tmp/bb-install:/tmp/clojure-install/bin:$PATH"
    
    # Copy configs
    rm -rf .clj-kondo/org.typedclojure
    mkdir -p .clj-kondo/org.typedclojure/typed.clj.runtime
    cp -r ../../typed/clj.runtime/resources/clj-kondo.exports/org.typedclojure/typed.clj.runtime/* .clj-kondo/org.typedclojure/typed.clj.runtime/
    
    set +e
    ./script/lint > /tmp/test-output 2>&1
    md5sum output/expected-output /tmp/test-output > /tmp/md5sums 2>&1
    
    # Compare md5 hashes
    local expected_md5=$(awk '{print $1; exit}' /tmp/md5sums)
    local actual_md5=$(awk '{print $1}' /tmp/md5sums | tail -1)
    set -e
    
    if [ "$expected_md5" = "$actual_md5" ]; then
        log "  Result: GOOD ✓"
        return 0
    else
        log "  Result: BAD ✗"
        return 1
    fi
}

# Binary search
left=0
right=$((TOTAL_RELEASES - 1))
first_bad=-1

log "Starting binary search..."
log ""

while [ $left -le $right ]; do
    mid=$(((left + right) / 2))
    release="${RELEASE_ARRAY[$mid]}"
    
    log "[$((mid + 1))/$TOTAL_RELEASES] Checking midpoint..."
    
    result=0
    test_release "$release" || result=$?
    
    if [ $result -eq 2 ]; then
        # Skip this release, try the next one
        left=$((mid + 1))
    elif [ $result -eq 0 ]; then
        # This release is good, search in the right half
        left=$((mid + 1))
    else
        # This release is bad, search in the left half
        first_bad=$mid
        right=$((mid - 1))
    fi
    log ""
done

# Report results
cd "$CLJ_KONDO_REPO"

if [ $first_bad -ge 0 ]; then
    BAD_RELEASE="${RELEASE_ARRAY[$first_bad]}"
    BAD_COMMIT=$(git rev-parse "$BAD_RELEASE")
    
    if [ $first_bad -gt 0 ]; then
        GOOD_RELEASE="${RELEASE_ARRAY[$((first_bad - 1))]}"
        GOOD_COMMIT=$(git rev-parse "$GOOD_RELEASE")
        
        if [ "$QUIET_MODE" = true ]; then
            echo "$GOOD_RELEASE $GOOD_COMMIT $BAD_RELEASE $BAD_COMMIT"
        else
            log "=== Binary Search Complete ==="
            log ""
            log "First BAD release found: $BAD_RELEASE"
            log ""
            log "Release commit: $BAD_COMMIT"
            log ""
            log "Previous GOOD release: $GOOD_RELEASE"
            log "Previous GOOD commit:  $GOOD_COMMIT"
            log ""
            log "To find the exact commit that introduced the bug, run:"
            log "  cd $PROJECT_DIR"
            log "  ./script/bisect-commit $GOOD_COMMIT $BAD_COMMIT"
        fi
    else
        if [ "$QUIET_MODE" = true ]; then
            echo "NONE NONE $BAD_RELEASE $BAD_COMMIT"
        else
            log "=== Binary Search Complete ==="
            log ""
            log "First BAD release found: $BAD_RELEASE"
            log "This is the first release tested. Cannot determine previous good release."
        fi
    fi
else
    if [ "$QUIET_MODE" = true ]; then
        echo "NONE"
    else
        log "=== Binary Search Complete ==="
        log ""
        log "No bad release found in the range. All releases passed!"
    fi
fi
